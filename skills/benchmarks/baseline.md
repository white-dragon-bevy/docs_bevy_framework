# 性能基准测试 - 基线参考

**最后更新**: 2025-10-25
**框架版本**: 0.2.4
**测试环境**: Roblox Cloud Testing Environment

## 概述

本文档记录了 White Dragon Bevy 框架的性能基准测试结果，作为监控性能退化和优化效果的基线参考。所有测试数据来自 `src/__tests__/performance-benchmarks.spec.ts` 测试套件。

## 性能目标

框架设计目标：
- **帧率**: 支持 60 FPS (16.67ms/帧)
- **实体规模**: 支持 10,000+ 实体
- **测试通过率**: 100% (1669/1669 测试通过)
- **核心操作延迟**: <1ms/帧

## 测试方法

所有性能测试使用 `os.clock()` 高精度计时器，测试环境为 Roblox Cloud。测试遵循以下原则：

1. **隔离性**: 每个测试在独立的 World/App 中运行
2. **可重复性**: 使用固定的实体数量和操作次数
3. **基准容差**: 使用 `expect().to.be.near()` 验证性能在可接受范围内
4. **环境一致性**: 云端和本地 Studio 环境均通过测试

## 性能基准汇总

### 1. ECS 核心性能

| 操作 | 规模 | 基准时间 | 说明 |
|------|------|---------|------|
| 实体创建 | 1000 个 | ≤10ms | 批量 spawn 操作 |
| 组件插入 | 1000 个 | ≤10ms | 单组件批量 insert |
| 实体查询 | 1000 个 | ≤5ms | 双组件查询 |
| 复杂查询 | 1000 个 | ≤15ms | 3+ 组件查询，带条件过滤 |
| 实体删除 | 1000 个 | ≤10ms | 批量 despawn 操作 |

**测试文件**: `src/__tests__/performance-benchmarks.spec.ts:220-328`

**关键发现**:
- ✅ 实体操作时间复杂度保持线性 (O(n))
- ✅ 查询性能不随实体数量二次增长
- ✅ 大批次 (1000) vs 小批次 (100) 时间比例 <15x

详细性能数据参见: [ecs-query.md](./ecs-query.md)

---

### 2. 资源管理性能

| 操作 | 规模 | 基准时间 | 说明 |
|------|------|---------|------|
| 资源插入 | 100 个 | ≤10ms | 批量 insertResource |
| 资源读取 | 1000 次 | ≤7ms | 重复 getResource 访问 |
| 复杂资源操作 | 100 次 | ≤10ms | 包含 Map 和 Array 的资源 |
| 元数据操作 | - | ≤1ms | getResourceMetadata 等 |

**测试文件**: `src/__tests__/performance-benchmarks.spec.ts:331-396`

**关键发现**:
- ✅ 资源访问是 O(1) 时间复杂度（TypeMap 实现）
- ✅ 复杂数据结构（Map, Array）不显著影响性能
- ✅ 元数据操作开销极低

详细性能数据参见: [resource-access.md](./resource-access.md)

---

### 3. 系统调度性能

| 操作 | 规模 | 基准时间 | 说明 |
|------|------|---------|------|
| 空系统执行 | 100 个 | ≤10ms | 最小系统开销 |
| 复杂查询系统 | 1000 实体 | ≤20ms | 多组件查询 + 条件处理 |
| 调度器构建 | 50 个系统 | ≤5ms | addSystems + 依赖解析 |
| 完整调度周期 | 5 阶段 | ≤20ms | First → Last 全流程 |
| 系统间依赖 | 100 次迭代 | ≤40ms | 资源共享场景 |

**测试文件**: `src/__tests__/performance-benchmarks.spec.ts:399-538`

**关键发现**:
- ✅ 系统调度开销可接受 (<0.1ms/系统)
- ✅ 调度器构建是一次性成本，不影响运行时性能
- ✅ 多阶段调度执行顺序正确且高效

详细性能数据参见: [scheduler.md](./scheduler.md)

---

### 4. 事件系统性能

| 操作 | 规模 | 基准时间 | 说明 |
|------|------|---------|------|
| 事件发送和接收 | 1000 个 | ≤10ms | 单帧事件处理 |
| 多类型事件 | 500 个 | ≤10ms | 2 种事件类型分类处理 |

**测试文件**: `src/__tests__/performance-benchmarks.spec.ts:541-656`

**关键发现**:
- ✅ 事件处理开销低 (<0.01ms/事件)
- ✅ 多类型事件不影响性能
- ⚠️ 建议每帧清空事件队列防止累积

---

### 5. 综合性能测试

#### 完整游戏循环模拟

- **场景**: 500 个实体，10 帧更新
- **阶段**: PreUpdate → Update → PostUpdate
- **基准时间**: ≤200ms (10 帧 × 20ms/帧)
- **实际性能**: 通过 ✅

**测试文件**: `src/__tests__/performance-benchmarks.spec.ts:659-727`

**包含操作**:
- 实体创建和组件初始化
- 每帧查询和条件过滤
- 组件动态添加和移除
- 游戏状态资源管理

#### 插件系统性能

- **场景**: 10 个插件，每个插件添加系统
- **基准时间**: ≤5ms
- **实际性能**: 通过 ✅

**测试文件**: `src/__tests__/performance-benchmarks.spec.ts:729-756`

---

## 性能退化检测

### 时间复杂度验证

框架通过以下测试验证算法复杂度：

#### 1. 实体操作线性增长验证
- 小批次: 100 实体
- 大批次: 1000 实体
- **预期比例**: ~10x (线性 O(n))
- **允许上限**: 15x (考虑系统开销)
- **测试结果**: 通过 ✅

#### 2. 查询性能线性验证
- 小批次查询: 100 实体
- 大批次查询: 1000 实体
- **预期比例**: ~10x (线性 O(n))
- **允许上限**: 15x
- **测试结果**: 通过 ✅

**测试文件**: `src/__tests__/performance-benchmarks.spec.ts:759-843`

---

## 环境差异

### 云端 vs 本地 Studio

| 特性 | 云端环境 | 本地 Studio |
|------|---------|------------|
| 测试执行 | ✅ 支持 | ✅ 支持 |
| 性能基准 | 基线数据源 | 开发验证 |
| 环境波动 | 轻微 (已调整容差) | 更稳定 |
| 测试通过率 | 100% (1669/1669) | 100% |

**注意**: 所有基准时间针对云端环境优化，本地 Studio 可能更快。

---

## 性能优化建议

基于测试结果的优化建议：

### 1. 实体管理
- ✅ **避免频繁创建/销毁**: 使用对象池模式重用实体
- ✅ **批量操作**: 优先使用批量 API 而非单个操作循环
- ⚠️ **监控实体数量**: 超过 10,000 实体时考虑空间分区

### 2. 查询优化
- ✅ **减少查询范围**: 使用最少必需的组件过滤
- ✅ **缓存查询结果**: 同一帧内多次使用相同查询时缓存迭代器
- ⚠️ **避免嵌套查询**: 嵌套查询会导致 O(n²) 复杂度

### 3. 系统设计
- ✅ **系统单一职责**: 每个系统只处理一类逻辑
- ✅ **合理调度阶段**: 根据依赖关系分配到正确的调度阶段
- ⚠️ **限制系统数量**: 超过 100 个系统时考虑合并或延迟加载

### 4. 资源使用
- ✅ **资源不可变**: 优先使用不可变资源模式
- ✅ **避免大型资源**: 单个资源大小建议 <100KB
- ⚠️ **控制资源数量**: 建议资源总数 <1000

### 5. 事件处理
- ✅ **每帧清空事件**: 防止事件队列无限增长
- ✅ **事件类型分离**: 不同优先级的事件使用不同队列
- ⚠️ **限制事件数量**: 单帧事件数建议 <10,000

---

## 性能监控

### 持续监控指标

在生产环境中，建议监控以下指标：

1. **帧率**: 目标 60 FPS，警告阈值 <50 FPS
2. **实体数量**: 实时监控，超过 10,000 时告警
3. **系统执行时间**: 记录最慢的 Top 10 系统
4. **内存使用**: 监控 World 和资源内存占用
5. **查询频率**: 识别热点查询进行优化

### 性能分析工具

- **内置性能计时器**: `PerformanceTimer` 类 (src/__tests__/performance-benchmarks.spec.ts:63)
- **统计辅助函数**: `measurePerformance()` (src/__tests__/performance-benchmarks.spec.ts:140)
- **Matter Hooks**: `world.useHook()` 用于系统内性能分析

---

## 版本历史

| 版本 | 日期 | 变更说明 | 性能影响 |
|------|------|---------|---------|
| 0.2.4 | 2025-10-24 | User Story 2 完成 - bevy_render, bevy_ecs_debugger 测试 | 无影响 |
| 0.2.3 | 2025-10-24 | 测试覆盖率提升项目完成 | 无影响 |
| 0.2.2 | 2025-10-20 | 初始性能基准测试套件 | 基线建立 |

---

## 参考文档

- [ECS 查询性能详细数据](./ecs-query.md)
- [资源访问性能详细数据](./resource-access.md)
- [调度器性能详细数据](./scheduler.md)
- [性能测试源代码](../../src/__tests__/performance-benchmarks.spec.ts)
- [测试覆盖率报告](../test-coverage/bevy_ecs.md)

---

## 联系方式

性能问题或建议请通过以下方式反馈：
- GitHub Issues: [bevy_framework/issues](https://github.com/white-dragon-bevy/bevy_framework/issues)
- 性能回归报告: 提供复现步骤和基准对比数据

---

**注意**: 性能数据会随 Roblox 平台更新和框架优化而变化，建议每个版本重新运行基准测试并更新本文档。
